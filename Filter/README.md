# ğŸ“¦ Geometry-Aware LOF Confidence Estimation

åŸºäº LOF + å±€éƒ¨å‡ ä½•ä¸€è‡´æ€§çš„ç‚¹äº‘ç½®ä¿¡åº¦ä¼°è®¡ï¼ˆå‡çº§ç‰ˆï¼‰

## ğŸ“‹ èƒŒæ™¯ä¸é—®é¢˜

å½“å‰ LOF æ–¹æ¡ˆ **åªè€ƒè™‘"ç‚¹-ç‚¹å±€éƒ¨å¯†åº¦"**ï¼Œå®ƒæ— æ³•åŒºåˆ†ï¼š

* âœ” çœŸæ­£çš„ç¦»ç¾¤ç‚¹ï¼ˆå™ªå£°ï¼‰
* âœ– ç¨€ç–ä½†åœ¨çœŸå®å‡ ä½•ç»“æ„ä¸Šçš„ç‚¹ï¼ˆæ¯”å¦‚è–„å¹³é¢è¾¹ç¼˜ï¼‰
* âœ– åœ¨å¤§å¹³é¢ä¸Šçš„æ­£å¸¸ç‚¹ï¼ˆä½†å¯†åº¦ç•¥ä½ï¼‰

ä¹Ÿå°±æ˜¯è¯´ï¼š

> **LOF æ˜¯"ç»Ÿè®¡å¼‚å¸¸"ï¼Œä¸æ˜¯"å‡ ä½•å¼‚å¸¸"**

å¦‚æœä¸€ä¸ªç‚¹è½åœ¨çœŸå®å¹³é¢ä¸Šï¼Œå³ä½¿é‚»åŸŸå¯†åº¦ç•¥ä½ï¼Œå®ƒä¹Ÿåº”è¯¥æ˜¯é«˜å¯ä¿¡çš„ã€‚

---

## âœ… å‡çº§ç‰ˆæ–¹æ¡ˆï¼šLOF + å±€éƒ¨å‡ ä½•ä¸€è‡´æ€§

æˆ‘ä»¬æŠŠæ–¹æ³•å‡çº§ä¸ºï¼š

> **ğŸ“¦ Geometry-Aware LOF Confidence Estimation**  
> å±€éƒ¨å¯†åº¦å¼‚å¸¸ + å±€éƒ¨å¹³é¢ä¸€è‡´æ€§è”åˆç½®ä¿¡åº¦

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›æ€è·¯

ä¸ºæ¯ä¸ªç‚¹è®¡ç®—ä¸‰ä¸ªåˆ†é‡ï¼š

### 1ï¸âƒ£ å¯†åº¦ä¸€è‡´æ€§ï¼ˆDensity Confidenceï¼‰

åŸæœ‰ LOF ç½®ä¿¡åº¦ï¼š

$$w_{lof} = \exp(-\alpha \cdot \max(0, LOF - 1))$$

è¡¡é‡"æ˜¯å¦æ˜¯å¯†åº¦ç¦»ç¾¤ç‚¹"ã€‚

---

### 2ï¸âƒ£ å±€éƒ¨å¹³é¢ä¸€è‡´æ€§ï¼ˆPlanarity Confidenceï¼‰

å¯¹äºæ¯ä¸ªç‚¹ï¼š

1. æ‰¾ k é‚»åŸŸ
2. ç”¨ PCA æ‹Ÿåˆå±€éƒ¨å¹³é¢
3. è®¡ç®—è¯¥ç‚¹åˆ°å±€éƒ¨å¹³é¢çš„è·ç¦»

è®¾é‚»åŸŸåæ–¹å·®çŸ©é˜µç‰¹å¾å€¼ï¼š

$$\lambda_1 \ge \lambda_2 \ge \lambda_3$$

#### (a) å¹³é¢æ€§æŒ‡æ ‡ï¼ˆSurface Variationï¼‰

$$S = \frac{\lambda_3}{\lambda_1 + \lambda_2 + \lambda_3}$$

* å° â†’ æ›´å¹³é¢
* å¤§ â†’ æ›´æ•£ä¹±ï¼ˆå™ªå£°ï¼‰

#### (b) ç‚¹åˆ°å±€éƒ¨å¹³é¢çš„è·ç¦»

$$d_i = |n^T (p_i - \bar{p})|$$

å®šä¹‰å‡ ä½•æƒé‡ï¼š

$$w_{plane} = \exp(-\beta d_i)$$

æˆ–è€…ç”¨ç»“æ„æŒ‡æ ‡ï¼š

$$w_{structure} = \exp(-\gamma S)$$

---

## ğŸ§  æœ€ç»ˆè”åˆç½®ä¿¡åº¦

æˆ‘ä»¬å®šä¹‰ï¼š

$$w_i = w_{lof} \cdot w_{plane} \cdot w_{structure}$$

æˆ–è€…æ›´ç¨³å®šç‰ˆæœ¬ï¼ˆåŠ æƒèåˆï¼‰ï¼š

$$w_i = w_{lof}^{\alpha_1} \cdot w_{plane}^{\alpha_2} \cdot w_{structure}^{\alpha_3}$$

å¹¶è£å‰ªåˆ°æœ‰æ•ˆèŒƒå›´ï¼š

$$w_i \in [min\_weight, 1]$$

---

## ğŸ“Œ ç›´è§‚è§£é‡Š

| æƒ…å†µ | LOF | å¹³é¢ä¸€è‡´æ€§ | æœ€ç»ˆç»“æœ |
|------|-----|-----------|---------|
| åœ¨å¤§å¹³é¢ä¸Š | æ­£å¸¸ | å¼ºå¹³é¢ | é«˜ç½®ä¿¡ |
| è–„ç»“æ„ | æ­£å¸¸ | å¹³é¢æ€§ä½ä½†ä¸€è‡´ | ä¸­ç­‰ç½®ä¿¡ |
| éšæœºå™ªå£° | é«˜LOF | æ— ç»“æ„ | æä½ç½®ä¿¡ |
| æ‚¬ç©ºç‚¹ | é«˜LOF | æ— ç»“æ„ | æä½ç½®ä¿¡ |
| ç¨€ç–è¾¹ç¼˜ | LOFç•¥é«˜ | ä»åœ¨å¹³é¢ä¸Š | ä¸ä¼šè¢«è¯¯åˆ  |

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
filter/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ geometry_lof.yaml            # å‡ ä½•å¢å¼º LOF é…ç½®
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ geometry_lof_confidence.py   # å‡ ä½•å¢å¼º LOF è„šæœ¬
â”œâ”€â”€ outputs/
â”‚   â”œâ”€â”€ geometry_confidence.npy      # å‡ ä½•å¢å¼ºç½®ä¿¡åº¦
â”‚   â””â”€â”€ geometry_filtered.ply
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ lof_colored.ply
â”‚   â”œâ”€â”€ planarity_colored.ply        # å¹³é¢æ€§å¯è§†åŒ–
â”‚   â”œâ”€â”€ distance_colored.ply         # ç‚¹åˆ°é¢è·ç¦»å¯è§†åŒ–
â”‚   â”œâ”€â”€ confidence_colored.ply
â”‚   â””â”€â”€ confidence_histograms.png
â””â”€â”€ README.md
```

---

## âš™ï¸ é…ç½®å‚æ•°

### åŸºç¡€é…ç½®ï¼ˆç»§æ‰¿è‡ª LOFï¼‰

```yaml
input:
  pointcloud_path: data/input.ply

output:
  output_dir: outputs
  filtered_ply: filtered.ply
  save_confidence_npy: true

preprocess:
  voxel_downsample:
    enable: true
    voxel_size: 0.02

lof:
  n_neighbors: 30
  metric: euclidean

confidence:
  exponential:
    alpha: 2.0
  min_weight: 0.05
```

### æ–°å¢å‡ ä½•å‚æ•°

```yaml
geometry:
  k_neighbors: 30          # ç”¨äº PCA çš„é‚»åŸŸç‚¹æ•°

  plane_distance:
    enable: true
    beta: 20.0              # ç‚¹åˆ°é¢è·ç¦»çš„è¡°å‡ç³»æ•°

  structure:
    enable: true
    gamma: 10.0             # ç»“æ„æŒ‡æ ‡ï¼ˆsurface variationï¼‰çš„è¡°å‡ç³»æ•°

fusion:
  alpha_lof: 1.0            # LOF æƒé‡æŒ‡æ•°
  alpha_plane: 1.0           # å¹³é¢è·ç¦»æƒé‡æŒ‡æ•°
  alpha_structure: 1.0       # ç»“æ„æŒ‡æ ‡æƒé‡æŒ‡æ•°
```

---

## ğŸ“ æ•°å­¦å®Œæ•´æ¨¡å‹

### Step 1ï¼šè®¡ç®— LOF ç½®ä¿¡åº¦

$$w_{lof} = \exp(-\alpha \cdot \max(0, LOF - 1))$$

---

### Step 2ï¼šPCA å¹³é¢æ‹Ÿåˆ

å¯¹æ¯ä¸ªç‚¹ $p_i$ï¼š

1. æ‰¾ k é‚»åŸŸï¼š$\mathcal{N}_i = \{p_j : \|p_j - p_i\| \le r\}$
2. è®¡ç®—åæ–¹å·®çŸ©é˜µï¼š$C = \frac{1}{|\mathcal{N}_i|} \sum_{j \in \mathcal{N}_i} (p_j - \bar{p})(p_j - \bar{p})^T$
3. ç‰¹å¾å€¼åˆ†è§£ï¼š$C = U \Lambda U^T$ï¼Œå¾—åˆ° $\lambda_1 \ge \lambda_2 \ge \lambda_3$
4. æ³•å‘é‡ï¼š$n = U[:, 2]$ï¼ˆæœ€å°ç‰¹å¾å€¼å¯¹åº”çš„ç‰¹å¾å‘é‡ï¼‰

---

### Step 3ï¼šå‡ ä½•ä¸€è‡´æ€§

#### ç»“æ„æŒ‡æ ‡ï¼ˆSurface Variationï¼‰

$$S = \frac{\lambda_3}{\lambda_1 + \lambda_2 + \lambda_3}$$

$$w_{structure} = \exp(-\gamma S)$$

#### ç‚¹åˆ°é¢è·ç¦»

$$d_i = |n^T (p_i - \bar{p})|$$

$$w_{plane} = \exp(-\beta d_i)$$

---

### Step 4ï¼šèåˆ

$$w_i = w_{lof}^{\alpha_1} \cdot w_{plane}^{\alpha_2} \cdot w_{structure}^{\alpha_3}$$

å¹¶è£å‰ªï¼š

$$w_i \in [min\_weight, 1]$$

---

## ğŸ”¥ ä¸ºä»€ä¹ˆè¿™ä¸ªç‰ˆæœ¬æ›´åˆç†ï¼Ÿ

å®ƒåŒæ—¶è€ƒè™‘ï¼š

| ç»´åº¦ | ä½œç”¨ |
|------|------|
| å¯†åº¦ | å‘ç°å­¤ç«‹ç‚¹ |
| å±€éƒ¨å‡ ä½• | åˆ¤æ–­æ˜¯å¦åœ¨çœŸå®é¢ä¸Š |
| ç»“æ„ç¨³å®šæ€§ | åˆ¤æ–­æ˜¯å¦æ˜¯å¹³é¢/æ›²é¢ç»“æ„ |

---

## ğŸ§  æ›´è¿›ä¸€æ­¥ï¼ˆå¯é€‰è¿›é˜¶ï¼‰

å¦‚æœä½ å¸Œæœ›å†å‡çº§ä¸€ç‰ˆï¼Œå¯ä»¥åŠ å…¥ï¼š

### ğŸ”¹ å±€éƒ¨æ›²ç‡ä¸€è‡´æ€§

åˆ©ç”¨ï¼š

$$C = \frac{\lambda_3}{\lambda_1}$$

åŒºåˆ†ï¼š

* æ›²é¢
* å¹³é¢
* å™ªå£°

### ğŸ”¹ RANSAC å¹³é¢æ”¯æŒåº¦

ç»Ÿè®¡é‚»åŸŸä¸­å¤šå°‘æ¯”ä¾‹ç‚¹è½åœ¨æ‹Ÿåˆå¹³é¢å†…ï¼š

$$support\_ratio = \frac{|\{p_j : |n^T(p_j - \bar{p})| < \epsilon\}|}{|\mathcal{N}_i|}$$

æ›´é²æ£’äºå™ªå£°ã€‚

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### Step 1: è®¡ç®—ç½®ä¿¡åº¦

```bash
cd /root/autodl-tmp/code/ColmapUtil/Filter
python scripts/geometry_lof_confidence.py config/geometry_lof.yaml
```

è¿™å°†ç”Ÿæˆï¼š
- `outputs/geometry_confidence.npy`ï¼šæ¯ä¸ªç‚¹çš„ç½®ä¿¡åº¦æ•°ç»„
- `outputs/confidence_info.txt`ï¼šç‚¹äº‘è·¯å¾„å’Œç½®ä¿¡åº¦ç»Ÿè®¡ä¿¡æ¯

### Step 2: äº¤äº’å¼å¯è§†åŒ–ä¸è¿‡æ»¤

ä½¿ç”¨å¯è§†åŒ–å·¥å…·äº¤äº’å¼åœ°è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼å¹¶ä¿å­˜è¿‡æ»¤åçš„ç‚¹äº‘ï¼š

```bash
python scripts/visualize_confidence.py
```

æˆ–è€…æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼š

```bash
python scripts/visualize_confidence.py \
    --confidence_file outputs/geometry_confidence.npy \
    --pointcloud /path/to/your/pointcloud.ply \
    --port 8091
```

**å¯è§†åŒ–åŠŸèƒ½**ï¼š
- ğŸšï¸ **ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—**ï¼šå®æ—¶è°ƒæ•´é˜ˆå€¼ï¼Œé¢„è§ˆè¿‡æ»¤æ•ˆæœ
- ğŸ”´ **çº¢è‰²å¤§ç‚¹**ï¼šæ˜¾ç¤ºç½®ä¿¡åº¦ä½äºé˜ˆå€¼çš„ç‚¹ï¼ˆå°†è¢«åˆ é™¤ï¼‰
- ğŸŸ¢ **æ­£å¸¸ç‚¹**ï¼šæ˜¾ç¤ºç½®ä¿¡åº¦é«˜äºé˜ˆå€¼çš„ç‚¹ï¼ˆå°†è¢«ä¿ç•™ï¼‰
- ğŸ’¾ **ä¿å­˜æŒ‰é’®**ï¼šä¿å­˜è¿‡æ»¤åçš„ç‚¹äº‘åˆ° `outputs/` ç›®å½•

### é…ç½®è¾“å…¥ç‚¹äº‘

ç¼–è¾‘ `config/geometry_lof.yaml` æ–‡ä»¶ï¼Œä¿®æ”¹ `input.pointcloud_path`ï¼š

```yaml
input:
  pointcloud_path: /path/to/your/pointcloud.ply
```

---

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

### ä¸»è¦è¾“å‡ºï¼ˆ`outputs/` ç›®å½•ï¼‰

- **`geometry_confidence.npy`**ï¼šæ¯ä¸ªç‚¹çš„è”åˆç½®ä¿¡åº¦æ•°ç»„ `w_i âˆˆ [min_weight, 1]`
  - NumPy æ•°ç»„æ ¼å¼ï¼Œå¯ç›´æ¥ç”¨äºåç»­åŠ æƒä¼˜åŒ–
  - å½¢çŠ¶ï¼š`(N,)`ï¼Œå…¶ä¸­ N ä¸ºç‚¹äº‘ä¸­çš„ç‚¹æ•°
  - **å§‹ç»ˆç”Ÿæˆ**ï¼Œç”¨äºå¯è§†åŒ–å·¥å…·

- **`confidence_info.txt`**ï¼šç½®ä¿¡åº¦å…ƒä¿¡æ¯æ–‡ä»¶
  - åŒ…å«ç‚¹äº‘è·¯å¾„ã€ç½®ä¿¡åº¦ç»Ÿè®¡ç­‰ä¿¡æ¯
  - ç”¨äºå¯è§†åŒ–å·¥å…·è‡ªåŠ¨å®šä½ç‚¹äº‘æ–‡ä»¶

- **`geometry_filtered.ply`**ï¼ˆå¯é€‰ï¼‰ï¼šåŸºäºé…ç½®ä¸­æœ€å°ç½®ä¿¡åº¦é˜ˆå€¼çš„è‡ªåŠ¨è¿‡æ»¤ç»“æœ
  - ä»…å½“ `filter.enable: true` æ—¶ç”Ÿæˆ
  - å»ºè®®ä½¿ç”¨å¯è§†åŒ–å·¥å…·è¿›è¡Œäº¤äº’å¼è¿‡æ»¤

### å¯è§†åŒ–æ–‡ä»¶ï¼ˆ`logs/` ç›®å½•ï¼‰

- **`lof_colored.ply`**ï¼šæŒ‰ LOF å€¼ç€è‰²çš„ç‚¹äº‘
- **`planarity_colored.ply`**ï¼šæŒ‰å¹³é¢æ€§æŒ‡æ ‡ S ç€è‰²çš„ç‚¹äº‘
- **`distance_colored.ply`**ï¼šæŒ‰ç‚¹åˆ°é¢è·ç¦»ç€è‰²çš„ç‚¹äº‘
- **`confidence_colored.ply`**ï¼šæŒ‰æœ€ç»ˆç½®ä¿¡åº¦ç€è‰²çš„ç‚¹äº‘

---

## ğŸ”§ è°ƒå‚å»ºè®®

1. **æŸ¥çœ‹å¯è§†åŒ–ç»“æœ**ï¼šè¿è¡ŒåæŸ¥çœ‹ `logs/` ç›®å½•ä¸­çš„ç€è‰²ç‚¹äº‘ï¼Œæ£€æŸ¥å„åˆ†é‡æ•ˆæœ
2. **è°ƒæ•´èåˆæƒé‡**ï¼š
   - å¦‚æœå¸Œæœ›æ›´ä¾èµ–å‡ ä½•ä¿¡æ¯ï¼Œå¢å¤§ `fusion.alpha_plane` å’Œ `fusion.alpha_structure`
   - å¦‚æœå¸Œæœ›æ›´ä¾èµ–å¯†åº¦ä¿¡æ¯ï¼Œå¢å¤§ `fusion.alpha_lof`
3. **è°ƒæ•´å‡ ä½•å‚æ•°**ï¼š
   - `geometry.plane_distance.beta`ï¼šè¶Šå¤§ï¼Œå¯¹ç‚¹åˆ°é¢è·ç¦»è¶Šæ•æ„Ÿ
   - `geometry.structure.gamma`ï¼šè¶Šå¤§ï¼Œå¯¹ç»“æ„æ•£ä¹±åº¦è¶Šæ•æ„Ÿ
4. **è°ƒæ•´é‚»åŸŸå¤§å°**ï¼š
   - ç‚¹äº‘å¯†åº¦é«˜ï¼šå¢å¤§ `geometry.k_neighbors`ï¼ˆå¦‚ 50ï¼‰
   - ç‚¹äº‘å¯†åº¦ä½ï¼šå‡å° `geometry.k_neighbors`ï¼ˆå¦‚ 20ï¼‰

---

## ğŸ“Œ æ€»ç»“

### åŸæ–¹æ³•é—®é¢˜

* åªè€ƒè™‘"ç»Ÿè®¡å¯†åº¦"
* ä¸çŸ¥é“ç‚¹æ˜¯å¦åœ¨çœŸå®å‡ ä½•ç»“æ„ä¸Š

### å‡çº§æ–¹æ³•

* **LOF** â†’ æ§åˆ¶å¯†åº¦å¼‚å¸¸
* **PCA** â†’ åˆ¤æ–­å±€éƒ¨é¢ç»“æ„
* **ç‚¹åˆ°é¢è·ç¦»** â†’ åˆ¤æ–­å‡ ä½•ä¸€è‡´æ€§
* **å¤šæƒé‡èåˆ** â†’ è¾“å‡ºè¿ç»­ç½®ä¿¡åº¦

---

## ğŸ“„ ç›¸å…³æ–‡æ¡£

- [scikit-learn LOF æ–‡æ¡£](https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.LocalOutlierFactor.html)
- [Open3D æ–‡æ¡£](http://www.open3d.org/docs/)
