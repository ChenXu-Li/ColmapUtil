# 普通图像（针孔相机）重建配置
# 适用于标准透视相机图像的重建

# 数据路径
paths:
  input_images: "/root/autodl-tmp/data/MobilePhone/Road/images"  # 输入图像目录
  output_path: "/root/autodl-tmp/data/MobilePhone/Road/colmap"   # 输出路径
  database_path: "" # 数据库路径（自动生成）

# 特征提取配置
feature_extraction:
  use_gpu: true
  gpu_index: "0"
  num_threads: 4
  # 特征提取器类型: SIFT, ORB, 等
  detector_type: "SIFT"
  max_image_size: 3200
  max_num_features: 8192

# 特征匹配配置
feature_matching:
  use_gpu: true
  gpu_index: "0"
  num_threads: 4
  # 匹配器类型: exhaustive, sequential, spatial, vocabtree
  matcher_type: "sequential"
  # Sequential匹配器配置
  sequential:
    overlap: 10
    loop_detection: true
    loop_detection_period: 10
  # Spatial匹配器配置
  spatial:
    is_gps: false
    ignore_z: false
    max_num_neighbors: 50
    max_distance: 100.0

# 稀疏重建配置
sparse_reconstruction:
  # Mapper选项
  init_min_num_inliers: 100
  init_max_error: 4.0
  init_min_tri_angle: 16.0
  init_max_reg_trials: 2
  
  abs_pose_min_num_inliers: 30
  abs_pose_min_inlier_ratio: 0.25
  abs_pose_max_error: 4.0
  
  filter_min_tri_angle: 1.5
  filter_max_reproj_error: 4.0
  filter_max_transitivity: 0.0
  
  # Bundle Adjustment配置
  ba_refine_focal_length: true
  ba_refine_principal_point: false
  ba_refine_extra_params: true
  ba_min_num_residuals_for_multi_threading: 50000

# 稠密重建配置
dense_reconstruction:
  # 图像去畸变
  undistortion:
    max_image_size: 3200
  
  # Patch Match配置
  patch_match:
    quality: "medium"  # low, medium, high, extreme
    max_image_size: 3200
    window_radius: 7
    window_step: 1
    num_iterations: 5
    geom_consistency: true
    filter_min_ncc: 0.1
    filter_min_num_consistent: 2
    filter_min_triangulation_angle: 1.0
    gpu_index: "0"
  
  # 点云融合配置
  stereo_fusion:
    max_image_size: 3200
    min_num_pixels: 5
    max_num_pixels: 10000
    max_traversal_depth: 100
    max_reproj_error: 2.0
    max_depth_error: 0.01
    max_normal_error: 0.1
    check_num_images: 50
    num_threads: 8

# 输出格式
output:
  # 稀疏重建输出
  sparse_format: "binary"  # binary 或 text
  # 稠密重建输出
  dense_format: "ply"  # ply 或 bin
  # 是否导出相机参数
  export_cameras: true
  # 是否导出图像列表
  export_images: true

# 环境变量（避免OpenBLAS问题）
environment:
  OMP_NUM_THREADS: 4
  MKL_NUM_THREADS: 4
  OPENBLAS_NUM_THREADS: 4
  NUMEXPR_NUM_THREADS: 4
  VECLIB_MAXIMUM_THREADS: 4
